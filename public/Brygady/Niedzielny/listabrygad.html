<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../style_css/headermenu.css">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Wybór dnia</title>
    <style>
        body {
            background: rgb(50, 50, 50);
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            color: white;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: -13px;
        }

        table {
            width: 35%;
            border-collapse: collapse;
            border-radius: 5px;
            overflow: hidden;
        }

        th,
        td {
            text-align: center;
            padding: 10px;
            border: 1px solid #ccc;
        }

        thead {
            background-color: rgba(163, 120, 0);
        }

        td {
            font-size-adjust: auto;
        }

        .bordered {
            border: 1.5px solid white;
            padding: 7px;
            width: 20px;
            display: inline-block;
            margin: 2px 2px;
            font-weight: bolder;
            align-items: center;
        }

        .borderedRez {
            font-size: 0px;
        }

        .movetobrygada {
            text-decoration: none;
            color: white;
            font-size: 17px;

        }

        .filter-container {
            margin-bottom: 10px;
        }

        .filter-input {
            display: inline-block;
            justify-content: center;
            align-items: center;
            text-align: center;
            text-decoration: none;
            color: white;
            background-color: rgba(50, 50, 50);
            border: 2px solid;
            border-radius: 10px;
            padding: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            width: 112px;
            max-width: 440px;
            margin-bottom: 10px;
        }

        .filter-label {
            font-weight: bold;
            margin-right: 5px;
        }

        .top {
            margin: 10px;
            margin-bottom: 30px;
        }

        h4 {
            margin: 0px 0px 10px;
        }

        .szary {
            color: grey;
            font-size: 10px;
        }

        header {
            position: sticky;
            top: 0px;
            background-color: rgb(50, 50, 50);
        }

        @keyframes blink {
            0% {
                background-color: red;
            }

            50% {
                background-color: transparent;
            }

            100% {
                background-color: red;
            }
        }

        .blink {
            animation: blink 1s infinite;
        }

        @keyframes mruganie {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        .svg-blink {
            fill: green;
            animation: mruganie 2s infinite;
            vertical-align: middle;
            margin-left: 6px;
        }

        .center-cell {

            flex-direction: column;
            align-items: center;
            /* wyśrodkowanie poziome */
            justify-content: center;
            /* wyśrodkowanie pionowe */
            text-align: center;
            /* wyśrodkowanie tekstu */
        }

        .live-stan-yellow {
            color: orange;
        }

        .live-timer {
            font-size: 0.7em;
            margin-top: 0px;
            text-align: center;
            color: rgb(212 165 32);
        }

    </style>
</head>

<body>
    <header>
        <a href="../../Main_Panel.html" class="menu">Panel Główny</a>
        <a href="../../Przystanki/listaprzystankow.html" class="menu">Przystanki</a>
        <a href="../ChooseDay.html" class="menu">Brygady</a>
        <a href="../../Brygady/Kursy/Kursy.html" class="menu">Kursy</a>
        <a href="../../Pojazdy_Live/PojazdyLIVE.html" class="menu">Pojazdy LIVE</a>
        <a href="#" class="menu exit" id="logout">Opuść Panel</a>
        <hr>
    </header>


    <center>
        <h1>Rozkład {Jaki?}</h1>
        <p class="top">Ważny od dnia <span id="waznyOd">ładowanie...</span></p>
    </center>

    <div class="filter-container">
        <center>
            <h4>Filtruj według:</h4>

            <input type="text" id="filterBrygada" class="filter-input" placeholder="Numer Brygady">

            <input type="text" id="filterLinie" class="filter-input" placeholder="Numer linii">
            <br>
            <a href="#" class="filtracja" id="greyFilter">Jednozmianowa</a>
            <a href="#" class="filtracja" id="orangeFilter">Dwuzmianowa</a>
            <br>
            <a href="#" class="filtracja" id="purpleFilter">Szczytowa</a>
            <a href="#" class="filtracja" id="blackFilter">Nocna</a>
            <br>
            <a href="#" class="filtracja" id="OnlyLIVE" style="width: 90%; display: none;">Wyświetl Pojazdy LIVE</a>
            <!-- <p class="szary">Po wpisaniu 'Rez' w filtrze linii, wyświetlają się wszystkie brygady z rezerwą :3</p> -->
            <hr>
            <a class="menu" style="font-size: 15px;" href="Podmiany.html">Lista podmian</a>
            <a class="menu" style="font-size: 15px;" href="Rezerwy.html">Lista rezerw</a>
        </center>
    </div>



    <table id="PierwszaTabela">
        <thead>
            <tr>
                <th>Brygada</th>
                <th>Linie</th>
                <th>Godz. Rozp.</th>
                <th>Godz. Zak.</th>
                <th style="display: none;">Km</th>
                <th>Autobus <br> LIVE</th>

            </tr>
        </thead>
        <tbody id="dataTableBody">
            <!-- Wiersze zostaną dodane dynamicznie -->
        </tbody>
    </table>

    <div id="filtrowanie" style="width: 70%;">

    </div>

    <table id="wykazstrony" style="width: 90%; display: none;">
        <thead>
            <tr>
                <th>Numer Autobusu</th>
                <th>Brygada</th>
                <th style="display: none;">Model Autobusu</th>
                <th>Opóźnienie</th>
                <th>Numer Linii</th>
                <th>Kierunek</th>
                <th style="display: none;">Następny kierunek</th>
                <th>Godzina odjazdu</th>
            </tr>
        </thead>
        <tbody id="dane-wykaz">
            <!-- Wiersze zostaną dodane automatycznie -->
        </tbody>
    </table>

    <script>
        sessionStorage.clear("BrygadaType");
        let brygadaNumber = localStorage.getItem("ChoosedTypeOfRozklad") || "Brak danych";
        let miasto = localStorage.getItem("Miasto");
        async function fetchDate() {
            try {
                const response = await fetch(`../../../Brygady/${miasto}/WYNIKI/Gotowe_brygady/wazny_od.txt`);
                if (!response.ok) {
                    throw new Error('Błąd podczas ładowania daty');
                }
                const dateText = await response.text();
                document.getElementById('waznyOd').textContent = dateText.trim();
            } catch (error) {
                console.error('Błąd:', error);
                document.getElementById('waznyOd').textContent = 'Błąd ładowania daty';
            }
        }



        document.addEventListener("DOMContentLoaded", function() {

            document.querySelector('h1').innerHTML = `Rozkład ${brygadaNumber}`;
        });

        function checkLogin() {
            const user = JSON.parse(localStorage.getItem('user'));

            if (!user) {
                window.location.href = '../../zoltakartka.html';
            }
        }

        function normalizeTime(time) {
            const parts = time.split(':'); // Rozdziel na godziny, minuty i sekundy
            if (parts.length !== 2) return time; // Sprawdź, czy format jest poprawny
            let hours = parseInt(parts[0], 10);
            const minutes = parseInt(parts[1], 10);
            const seconds = parseInt(parts[2], 10);

            // Sprawdź, czy godziny są większe lub równe 24
            while (hours >= 24) {
                hours -= 24; // Odejmij 24 godziny
            }

            // Zwróć sformatowany czas
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        async function loadData() {
            try {
                const Miasto = localStorage.getItem('Miasto'); // Pobierz 'Miasto' z localStorage
                const response = await fetch(`/api/data?brygada=${brygadaNumber}&miasto=${encodeURIComponent(Miasto)}`);
                const data = await response.json();

                data.sort((a, b) => {
                    const parseBrygada = (brygada) => {
                        // Jeśli brygada to same litery (np. "Rez", "N", "X"), wrzucamy je na koniec
                        if (/^[A-Za-z]+$/.test(brygada)) {
                            return [Infinity, '', Infinity]; // największe wartości, by były na końcu
                        }

                        // Standardowy format np. "10N/01" lub "1N/02"
                        const match = brygada.match(/^(\d+)([A-Z]?)[/](\d+)$/);
                        if (!match) return [Infinity, '', Infinity]; // fallback na niepasujące

                        const [, main, letter, sub] = match;
                        return [parseInt(main), letter, parseInt(sub)];
                    };

                    const [mainA, letterA, subA] = parseBrygada(a.brygada);
                    const [mainB, letterB, subB] = parseBrygada(b.brygada);

                    if (mainA !== mainB) return mainA - mainB;
                    if (letterA !== letterB) return letterA.localeCompare(letterB);
                    return subA - subB;
                });



                const tableBody = document.getElementById('dataTableBody');

                data.forEach(item => {
                    const normalizedStart = normalizeTime(item.godzRozp); // Normalizuj czas rozpoczęcia
                    const normalizedEnd = normalizeTime(item.godzZak); // Normalizuj czas zakończenia

                    const row = document.createElement('tr');
                    row.innerHTML = `
        <td><a href="brygada.html" class="movetobrygada" onclick="saveBrygada('${item.brygada}')">${item.brygada}</a></td>
        <td><center>
            ${item.linie
                .split(/\s+/) // Rozdziela linie przy użyciu dowolnej liczby białych znaków (spacja, tabulator, itp.)
                .map(linia => 
                    linia === "Rez" 
                        ? `<span class="borderedRez" ">${linia}</span>` 
                        : `<span class="bordered">${linia}</span>`
                ).join(' ')}
        </center></td>
        <td>${normalizedStart}</td> <!-- Zaktualizowane -->
        <td>${normalizedEnd}</td> <!-- Zaktualizowane -->
        <td style="display: none;">${item.km || 'N/A'}</td>
        <td></td> <!-- Nowa kolumna LIVE -->
    `;
                    tableBody.appendChild(row);
                });

            } catch (error) {
                console.error('Błąd podczas ładowania danych:', error);
            }
            checkBrygadaStatus();
        }

        function saveBrygada(brygada) {
            sessionStorage.setItem('brygadaTitle', brygada.replace(/\//g, "_")); // Zamień "/" na "_" i zapisz w sessionStorage
            sessionStorage.setItem('selectedBrygada', brygada); // Opcjonalne: możesz zachować również selectedBrygada
        }

        document.getElementById('logout').addEventListener('click', function() {
            localStorage.clear();
            window.location.href = '../../index.html';
        });

        // Funkcja do filtrowania tabeli
        function addFilters() {
            const filterLinie = document.getElementById('filterLinie');
            const filterBrygada = document.getElementById('filterBrygada');

            filterLinie.addEventListener('input', filterTable);
            filterBrygada.addEventListener('input', filterTable);
        }

        function filterTable() {
            const linieFilter = document.getElementById('filterLinie').value.toLowerCase();
            const brygadaFilter = document.getElementById('filterBrygada').value.toLowerCase();
            const rows = document.querySelectorAll('#dataTableBody tr');

            rows.forEach(row => {
                const linie = row.children[1].textContent.toLowerCase();
                const brygada = row.children[0].textContent.toLowerCase();
                const showRow = linie.includes(linieFilter) && brygada.startsWith(brygadaFilter);
                row.style.display = showRow ? '' : 'none';
            });
        }

        // Pobranie typu rozkładu z localStorage

        let activeDzien = brygadaNumber;

        async function checkBrygadaStatus() {
            const rows = document.querySelectorAll('#dataTableBody tr');

            try {
                let Miasto = localStorage.getItem('Miasto');

                const response = await fetch(`../../../Brygady/${Miasto}/WYNIKI/Gotowe_brygady/${brygadaNumber}/Brygady_BIS.txt`);
                if (!response.ok) {
                    console.error("Błąd podczas ładowania pliku Brygady_BIS.txt");
                    return;
                }
                const fileContent = await response.text();
                const lines = fileContent.split('\n');

                // Tworzenie mapy brygad i ich statusów (Bisówka lub JednoZmianówka)
                const brygadaStatusMap = {};
                lines.forEach(line => {
                    const [brygada, status] = line.split('\t');
                    if (brygada && status) {
                        brygadaStatusMap[brygada.trim()] = status.trim();
                    }
                });

                // Przejście przez wiersze tabeli i ustawienie koloru tła za tekstem w zależności od statusu
                rows.forEach(row => {
                    const brygadaCell = row.querySelector('td:first-child a');
                    const brygada = brygadaCell.textContent.trim();

                    if (brygadaStatusMap[brygada]) {
                        const status = brygadaStatusMap[brygada];
                        sessionStorage.setItem('BrygadaType', 'Brak Tła'); // reset dla tego wiersza, opcjonalne

                        if (status === 'B') {
                            brygadaCell.style.backgroundColor = 'purple';
                            brygadaCell.style.color = 'white';
                            sessionStorage.setItem('BrygadaType', 'Brygada Szczytowa');
                        } else if (status === 'JZ') {
                            brygadaCell.style.backgroundColor = 'grey';
                            brygadaCell.style.color = 'white';
                            sessionStorage.setItem('BrygadaType', 'Brygada Jednozmianowa');
                        } else if (status === 'X') {
                            brygadaCell.style.backgroundColor = 'rgba(163, 120, 0)';
                            brygadaCell.style.color = 'white';
                        } else if (status === 'JZN') {
                            brygadaCell.style.backgroundColor = 'black';
                            brygadaCell.style.color = 'white';
                            sessionStorage.setItem('BrygadaType', 'Brygada Nocna Jednozmianowa');
                        } else if (status === 'TRZEBA_RECZNIE_SPRAWDZIC') {
                            brygadaCell.classList.add('blink');
                        } else {
                            brygadaCell.style.backgroundColor = 'grey';
                            brygadaCell.style.color = 'white';
                        }

                        brygadaCell.style.padding = '2px 5px';
                        brygadaCell.style.borderRadius = '4px';

                        brygadaCell.addEventListener('click', function() {
                            sessionStorage.setItem('BrygadaType', 'Brygada Dwuzmianowa');
                            const backgroundColor = brygadaCell.style.backgroundColor;
                            if (backgroundColor === 'purple') {
                                sessionStorage.setItem('BrygadaType', 'Brygada Szczytowa');
                            } else if (backgroundColor === 'grey') {
                                sessionStorage.setItem('BrygadaType', 'Brygada Jednozmianowa');
                            } else if (backgroundColor === 'black') {
                                sessionStorage.setItem('BrygadaType', 'Brygada Nocna Jednozmianowa');
                            } else if (backgroundColor === 'rgba(0, 0, 1)') {
                                sessionStorage.setItem('BrygadaType', 'Brygada Nocna Dwuzmianowa');
                            }
                        });

                    } else {
                        // Gdy brak dopasowania - ustaw "N/A"
                        sessionStorage.setItem('BrygadaType', 'N/A');
                        brygadaCell.style.backgroundColor = ''; // opcjonalnie reset stylu
                        brygadaCell.style.color = '';
                    }
                });
            } catch (error) {
                console.error("Błąd:", error);
            }
        }







        function filterTable() {
            const linieFilter = document.getElementById('filterLinie').value.trim().toLowerCase(); // Pobieramy wartość filtra dla linii
            const brygadaFilter = document.getElementById('filterBrygada').value.trim().toLowerCase(); // Pobieramy wartość filtra dla brygady

            // Jeśli input dla numeru linii jest pusty, nie stosujemy filtra dla numerów
            const rows = document.querySelectorAll('#dataTableBody tr');

            // Sprawdzamy, które filtry kolorów są aktywne
            const purpleChecked = document.getElementById('purpleFilter').classList.contains('active');
            const greyChecked = document.getElementById('greyFilter').classList.contains('active');
            const orangeChecked = document.getElementById('orangeFilter').classList.contains('active');
            const blackChecked = document.getElementById('blackFilter').classList.contains('active');

            // Sprawdzamy, czy jakikolwiek filtr kolorów jest aktywny
            const isAnyColorChecked = purpleChecked || greyChecked || orangeChecked || blackChecked;

            rows.forEach(row => {
                const linie = row.children[1].textContent.trim().toLowerCase(); // Numer linii
                const brygada = row.children[0].textContent.trim().toLowerCase(); // Nazwa brygady
                const brygadaCell = row.querySelector("td:first-child a"); // Komórka zawierająca link do "Brygady"
                const backgroundColor = window.getComputedStyle(brygadaCell).backgroundColor; // Kolor tła brygady

                // Rozdzielamy zawartość komórki na poszczególne linie (np. "2", "10", "11") i sprawdzamy każdą z nich
                const linieArray = linie.split(/\s+/); // Rozdzielamy na linie, zakładając, że linie są oddzielone spacjami

                // Sprawdzamy, czy którykolwiek numer linii pasuje do filtra
                const matchesLinie = linieFilter ? linieArray.some(linia => linia === linieFilter) : true;

                // Porównanie dla brygady (zaczyna się od wprowadzonego tekstu) 
                const matchesBrygada = brygada.startsWith(brygadaFilter);

                let matchesColor = true; // Domyślnie ustawiamy, że kolor nie jest brany pod uwagę

                if (isAnyColorChecked) {
                    matchesColor = (
                        (backgroundColor === 'rgb(128, 0, 128)' && purpleChecked) || // Fioletowy
                        (backgroundColor === 'rgb(128, 128, 128)' && greyChecked) || // Szary
                        (backgroundColor === 'rgb(163, 120, 0)' && orangeChecked) || // Pomarańczowy
                        (backgroundColor === 'rgb(0, 0, 0)' && blackChecked) // Czarny
                    );
                }

                // Pokazujemy wiersz, jeśli pasuje do wszystkich filtrów (tekstowych i kolorowych, jeśli aktywne)
                if (matchesLinie && matchesBrygada && matchesColor) {
                    row.style.display = ''; // Pokazujemy wiersz

                    // Sprawdzamy, czy numer linii pasuje do filtra i zmieniamy jego kolor na pomarańczowy
                    if (linieFilter) {
                        // Znajdujemy wszystkie elementy <span> w komórce z numerem linii
                        const spans = row.children[1].querySelectorAll('span');
                        spans.forEach(span => {
                            const spanText = span.textContent.trim().toLowerCase();
                            if (spanText === linieFilter) {
                                span.style.color = 'orange'; // Kolorujemy tylko pasującą liczbę na pomarańczowo
                            } else {
                                span.style.color = ''; // Reszta pozostaje bez zmian
                            }
                        });
                    }
                } else {
                    row.style.display = 'none'; // Ukrywamy wiersz
                }

                // Jeśli pole filtra jest puste, resetujemy kolor na domyślny
                if (!linieFilter) {
                    const spans = row.children[1].querySelectorAll('span');
                    spans.forEach(span => {
                        span.style.color = ''; // Resetujemy kolor, gdy brak filtra
                    });
                }
            });
        }



        // Attach the filtering function to the click event of the color filter links
        function addFilters() {
            const filterLinie = document.getElementById('filterLinie');
            const filterBrygada = document.getElementById('filterBrygada');

            // Add event listeners to text filters (linie and brygada)
            filterLinie.addEventListener('input', filterTable);
            filterBrygada.addEventListener('input', filterTable);

            // Add event listeners to color filter links
            document.getElementById('purpleFilter').addEventListener('click', toggleFilter);
            document.getElementById('greyFilter').addEventListener('click', toggleFilter);
            document.getElementById('orangeFilter').addEventListener('click', toggleFilter);
            document.getElementById('blackFilter').addEventListener('click', toggleFilter);
        }

        // Function to toggle active class on the color filter links
        function toggleFilter(event) {
            // Toggle 'active' class on the clicked link
            const filterLink = event.target;
            filterLink.classList.toggle('active');

            // Check if all color filters are now active
            const allFiltersActive = document.getElementById('purpleFilter').classList.contains('active') &&
                document.getElementById('greyFilter').classList.contains('active') &&
                document.getElementById('orangeFilter').classList.contains('active') &&
                document.getElementById('blackFilter').classList.contains('active');

            // If all filters are active, remove 'active' class from all filters
            if (allFiltersActive) {
                document.getElementById('purpleFilter').classList.remove('active');
                document.getElementById('greyFilter').classList.remove('active');
                document.getElementById('orangeFilter').classList.remove('active');
                document.getElementById('blackFilter').classList.remove('active');
            }

            // Call filterTable after the class change
            filterTable();
        }

        document.addEventListener("DOMContentLoaded", function() {
            addFilters();
        });



        document.addEventListener("DOMContentLoaded", function() {
            const spanElement = document.getElementById("waznyOd");

            if (spanElement) {
                // Poczekaj, aż treść spana się załaduje (np. z backendu)
                const observer = new MutationObserver(() => {
                    let dateString = spanElement.textContent.trim();
                    let dateParts = dateString.split("/");

                    if (dateParts.length === 3) {
                        let spanDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]); // DD/MM/YYYY
                        let currentDate = new Date();
                        currentDate.setHours(0, 0, 0, 0);

                        if (spanDate > currentDate) {
                            spanElement.style.backgroundColor = "red";
                            spanElement.style.color = "white";
                        }
                    }
                });

                observer.observe(spanElement, {
                    childList: true
                });
            }
        });

        // Wywołaj funkcję po załadowaniu danych
        window.onload = async function() {
            debugger;
            try {
                loadData();
                console.log("Początek ładowania danych");

                await fetchDate();
                console.log("Daty pobrane");

                checkLogin();

                console.log("Dane załadowane");

                addFilters();
                await checkBrygadaStatus();

                console.log("Przygotowanie do ładowania modeli autobusów");

                const response = await fetch('ModeleAutobusow.txt');
                const text = await response.text();
                console.log("Plik modeli załadowany");

                checkLogin();
                parseModelFile(text);
                uzupelnijLiveZDrugiejTabeli();

                await loadAndRenderTable();
                await new Promise(resolve => setTimeout(resolve, 1000));
                uzupelnijLiveZDrugiejTabeli();

                setInterval(async () => {
                    await loadAndRenderTable();

                    uzupelnijLiveZDrugiejTabeli();
                }, 10000);

            } catch (err) {
                console.error('Błąd podczas ładowania:', err);
            }
        };









        let modelMap = [];
        let activeFilter = null;
        let activeDelaySort = '';
        let activeLineFilter = '';
        let activeBusNumberFilter = '';
        let wartoscdnia = "2"; // domyślnie np. "Powszedni"



        function parseModelFile(text) {
            modelMap = [];
            const lines = text.trim().split('\n');

            for (const line of lines) {
                const trimmed = line.trim();
                if (/^-{3,}.*-{3,}$/.test(trimmed)) {
                    modelMap.push({
                        model: trimmed,
                        entries: [],
                        display: '',
                        count: 0,
                        isCategory: true
                    });
                    continue;
                }

                const [rangePart, model] = trimmed.split('\t').map(s => s.trim());
                const entries = [];

                if (rangePart.includes(',')) {
                    entries.push(...rangePart.split(',').map(num => parseInt(num.trim(), 10)));
                } else if (rangePart.includes('-')) {
                    const [from, to] = rangePart.split('-').map(s => parseInt(s.trim(), 10));
                    for (let i = from; i <= to; i++) {
                        entries.push(i);
                    }
                } else if (!isNaN(rangePart)) {
                    entries.push(parseInt(rangePart, 10));
                }

                modelMap.push({
                    model,
                    entries,
                    display: rangePart,
                    count: 0,
                    isCategory: false
                });
            }
        }

        function updateModelCounts(vehicles) {
            modelMap.forEach(m => m.count = 0);
            for (const v of vehicles) {
                const nb = parseInt(v.getAttribute("nb"), 10);
                const matched = modelMap.find(entry => !entry.isCategory && entry.entries.includes(nb));
                if (matched) matched.count++;
            }
        }



        function parseDelay(text) {
            const match = text.match(/([-+])(\d{2}):(\d{2})/);
            if (!match) return 0;
            const sign = match[1] === '+' ? 1 : -1;
            const minutes = parseInt(match[2], 10);
            const seconds = parseInt(match[3], 10);
            return sign * (minutes * 60 + seconds);
        }

        /*

        function LoadBrygada(godzinaOdjazdu, kierunek, dzien, callback) {
            fetch(`/api/brygadaStrona?godzina=${encodeURIComponent(godzinaOdjazdu)}&kierunek=${encodeURIComponent(kierunek)}&dzien=${encodeURIComponent(dzien)}`)

                .then(response => response.json())
                .then(data => {
                    console.log('Dane otrzymane od serwera:', data);
                    // Przekazanie obu wartości do callbacka
                    callback(data.brygada, data.linia); // Przekazanie również linia
                })
                .catch(error => {
                    console.error('Błąd przy pobieraniu danych:', error);
                    callback('Błąd');
                });
        }


*/

        function loadAndRenderTable(dzien) {
            dzien = dzien || (document.getElementById('dzienSelect')?.value || activeDzien);

            const scrollTop = window.scrollY;
            const activeElement = document.activeElement;
            const wasFocused = activeElement?.tagName === 'SELECT' || activeElement?.tagName === 'INPUT';

            fetch('/api/vehicles')
                .then(response => response.text())
                .then(xmlString => {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlString, "text/xml");
                    const vehicles = Array.from(xmlDoc.getElementsByTagName("V"));

                    vehicles.sort((a, b) => {
                        const nbA = parseInt(a.getAttribute("nb")) || 0;
                        const nbB = parseInt(b.getAttribute("nb")) || 0;
                        return nbA - nbB;
                    });




                    const tbody = document.getElementById("dane-wykaz");
                    tbody.innerHTML = "";

                    vehicles.forEach(v => {
                        const nb = v.getAttribute("nb");
                        const brygada = v.getAttribute("kwi");
                        let nr = v.getAttribute("nr") || '';
                        const nnr = v.getAttribute("nnr") || '';

                        let op = v.getAttribute("op") || '';
                        const nop = v.getAttribute("nop") || '';
                        let p = v.getAttribute("p") || '';
                        const o = parseInt(v.getAttribute("o"), 10);
                        const isDelayed = o < 0;
                        const absO = Math.abs(o);
                        const minutes = Math.floor(absO / 60);
                        const seconds = absO % 60;
                        const formattedDelay = `${isDelayed ? '-' : '+' }${String(minutes).padStart(2, '0' )}:${String(seconds).padStart(2, '0' )}`;
                        const totalSeconds = (isDelayed ? -1 : 1) * (minutes * 60 + seconds);
                        let color = "#ffffff";
                        if (totalSeconds >= 1) {
                            color = "#0e8616";
                        } else if (totalSeconds < 0 && totalSeconds >= -300) {
                            color = "#ffbb00";
                        } else if (totalSeconds < -300 && totalSeconds >= -600) {
                            color = "#ff8000";
                        } else if (totalSeconds < -600 && totalSeconds >= -1200) {
                            color = "#ff0000";
                        } else if (totalSeconds < -1200) {
                            color = "#a80000";
                        }
                        const formattedTimeReal = `<span style="color: ${color}">${formattedDelay}</span>`;

                        if ((!nr || nr.trim() === '') && (!op || op.trim() === '') && (!p || p.trim() === '')) {
                            if (nop && nop.trim() !== '') {
                                op = `<span style="color: gray">${nop}</span>`;
                            }
                            if (nnr && nnr.trim() !== '') {
                                nr = `<span style="color: gray">${nnr}</span>`;
                            }

                            const now = new Date();
                            now.setSeconds(now.getSeconds() + totalSeconds);

                            if (now.getSeconds() >= 0 && now.getSeconds() < 30) {
                                now.setSeconds(0);
                            } else if (now.getSeconds() >= 30 && now.getSeconds() < 60) {
                                now.setMinutes(now.getMinutes() + 1);
                                now.setSeconds(0);
                            }
                            const hours = now.getHours().toString().padStart(2, '0');
                            const mins = now.getMinutes().toString().padStart(2, '0');
                            p = `${hours}:${mins}`;
                        }
                        const nbNum = parseInt(nb, 10);
                        const matched = modelMap.find(entry => !entry.isCategory && entry.entries.includes(nbNum));
                        const model = matched ? matched.model : 'N/A';

                        let formattedOp = op;
                        const pIndex = op.toLowerCase().indexOf("p.");
                        if (pIndex !== -1) {
                            const before = op.slice(0, pIndex).trim();
                            const after = op.slice(pIndex).trim();
                            formattedOp = `${before} <br> <span>${after}</span>`;
                        }

                        const row = document.createElement("tr");
                        row.innerHTML = `
                                    <td>${nb}</td>
                                    <td style="display: none;">${model}</td>
                                    <td>${brygada}</td>
                                    <td>${formattedTimeReal}</td>
                                    <td>${nr}</td>
                                    <td>${formattedOp}</td>
                                    <td style="display: none;">${nop}</td>
                                    <td>${p}</td>
                                    `;

                        tbody.appendChild(row);

                        // const cellBrygada = row.insertCell(2);
                        const cellLinie = row.cells[4];

                        if (cellLinie.textContent.trim() === "") {
                            cellLinie.textContent = linia;
                            cellLinie.style.color = 'grey';

                            const cellKierunek = row.cells[5];
                            cellKierunek.style.color = 'grey';

                            const cellOpoznienie = row.cells[3];
                            cellOpoznienie.style.color = 'white';
                        }
                    });



                    if (wasFocused) {
                        activeElement?.focus();
                    }

                    window.scrollTo({
                        top: scrollTop
                    });
                })
                .catch(error => {
                    console.error('Błąd przy pobieraniu danych:', error);
                });
        }




        function sprawdzDostepnosc() {
            console.log("Sprawdzanie dostępności...");

        }




        function uzupelnijLiveZDrugiejTabeli() {
            const pierwszaTabela = document.querySelector('#PierwszaTabela tbody');
            const drugaTabela = document.querySelector('#wykazstrony tbody');

            // Tworzymy mapę: Brygada -> Numer Autobusu z drugiej tabeli
            const mapaBrygadaNumer = {};
            for (const row of drugaTabela.rows) {
                const numerAutobusu = row.cells[0].textContent.trim();
                const brygada = row.cells[2].textContent.trim();
                if (brygada) {
                    mapaBrygadaNumer[brygada] = numerAutobusu;
                }
            }

            const svgIkonaOFF = `
<svg xmlns="http://www.w3.org/2000/svg" height="16" viewBox="0 0 24 24" width="16" style="fill:red;">
    <path d="m1 9 2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8 3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4 2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"></path>
</svg>
`;

            const svgIkonaLOST = `
<svg xmlns="http://www.w3.org/2000/svg" height="16" viewBox="0 0 24 24" width="16" style="fill:yellow;">
    <path d="m1 9 2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8 3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4 2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"></path>
</svg>
`;

            const svgIkona = `
<svg xmlns="http://www.w3.org/2000/svg" height="16" viewBox="0 0 24 24" width="16" class="svg-blink">
    <path d="m1 9 2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8 3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4 2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"></path>
</svg>
`;

            for (const row of pierwszaTabela.rows) {
                const brygada = row.cells[0].textContent.trim();
                const numerAutobusu = mapaBrygadaNumer[brygada];

                const komorkaLive = row.cells[5];
                const obecnaZawartosc = komorkaLive.textContent.trim();

                komorkaLive.style.textAlign = 'center';
                komorkaLive.classList.add('center-cell');

                const regexNumeru = /^\d{3,5}$/;
                const aktualnyStan = komorkaLive.getAttribute('data-live-state');
                const licznikId = komorkaLive.getAttribute('data-timer-id');

                if (numerAutobusu && numerAutobusu !== "null" && numerAutobusu !== "") {
                    komorkaLive.innerHTML = `
<div style="position: relative; display: inline-block; color: white;">
    ${numerAutobusu}
    <div style="position: absolute; top: -10px; right: -15px;">
        ${svgIkona}
    </div>
</div>`;
                    komorkaLive.removeAttribute('data-live-state');
                    komorkaLive.removeAttribute('data-timer-id');
                } else if (regexNumeru.test(obecnaZawartosc)) {
                    if (aktualnyStan !== 'yellow') {
                        const now = new Date();
                        const godzinaStartu = now.toTimeString().split(' ')[0]; // HH:MM:SS
                        const nowyLicznikId = `live-timer-${Math.floor(Math.random() * 1000000)}`;

                        komorkaLive.setAttribute('data-live-state', 'yellow');
                        komorkaLive.setAttribute('data-timer-id', nowyLicznikId);

                        komorkaLive.innerHTML = `
<div style="position: relative; display: inline-block;" class="live-stan-yellow godzina-${godzinaStartu.replace(/:/g, '')}">
    ${obecnaZawartosc}
    <div style="position: absolute; top: -10px; right: -15px;">
        ${svgIkonaLOST}
    </div>
    <div id="${nowyLicznikId}" class="live-timer">0s</div>
</div>`;

                        const interval = setInterval(() => {
                            const el = document.getElementById(nowyLicznikId);
                            if (el) {
                                const cell = el.closest('td');
                                const wrapperDiv = el.closest('div[class*="godzina-"]');
                                const match = [...wrapperDiv.classList].find(cls => cls.startsWith('godzina-'));
                                if (match) {
                                    const czasString = match.replace('godzina-', '');
                                    const h = parseInt(czasString.slice(0, 2), 10);
                                    const m = parseInt(czasString.slice(2, 4), 10);
                                    const s = parseInt(czasString.slice(4, 6), 10);
                                    const startTime = new Date();
                                    startTime.setHours(h, m, s, 0);
                                    const nowTime = new Date();
                                    let seconds = Math.floor((nowTime - startTime) / 1000);
                                    if (seconds < 0) seconds += 86400;
                                    el.textContent = `(${seconds} s.)`;
                                }
                            } else {
                                clearInterval(interval);
                            }
                        }, 1000);
                    }
                } else {
                    if (aktualnyStan !== 'yellow') {
                        komorkaLive.innerHTML = `${svgIkonaOFF}`;
                        komorkaLive.removeAttribute('data-live-state');
                        komorkaLive.removeAttribute('data-timer-id');
                    }
                }
            }
        }

        /*
         */

        document.addEventListener("DOMContentLoaded", async () => {
            const miasto = localStorage.getItem("Miasto");
            if (!miasto) return;

            const header = document.querySelector("header");
            if (!header) return;

            async function fetchTextFile(path) {
                const response = await fetch(path);
                return await response.text();
            }

            function parseMiasta(txt, szukaneMiasto) {
                txt = txt.replace(/\r/g, '');
                const bloki = txt.split('\n\n');
                for (const blok of bloki) {
                    const linie = blok.trim().split('\n');
                    if (linie[0].trim() === szukaneMiasto) {
                        const widoczneMenu = {};
                        for (let i = 2; i < linie.length; i++) {
                            const [klucz, wartosc] = linie[i].split(':').map(s => s.trim());
                            widoczneMenu[klucz] = (wartosc.toUpperCase() === 'TAK');
                        }
                        return widoczneMenu;
                    }
                }
                return {};
            }

            function normalizeKey(s) {
                return s.toLowerCase().trim();
            }

            try {
                const miastaText = await fetchTextFile("../../miasta.txt");
                const doDodania = parseMiasta(miastaText, miasto);

                const doDodaniaNormalized = {};
                for (const key in doDodania) {
                    doDodaniaNormalized[normalizeKey(key)] = doDodania[key];
                }

                const zawszeAktywne = [
                    "wybór miasta",
                    "panel główny",
                    "opuść panel"
                ];

                const linki = header.querySelectorAll("a.menu");
                linki.forEach(link => {
                    const tekst = link.textContent.trim();
                    const normTekst = normalizeKey(tekst);

                    if (zawszeAktywne.includes(normTekst)) {
                        link.style.color = "";
                        link.style.pointerEvents = "";
                        link.style.opacity = "";
                        return;
                    }

                    if (normTekst in doDodaniaNormalized) {
                        if (doDodaniaNormalized[normTekst]) {
                            link.style.color = "";
                            link.style.pointerEvents = "";
                            link.style.opacity = "";
                        } else {
                            link.style.color = "gray";
                            link.style.pointerEvents = "none";
                            link.style.opacity = "0.5";
                        }
                    } else {
                        link.style.color = "gray";
                        link.style.pointerEvents = "none";
                        link.style.opacity = "0.5";
                    }
                });

                // >>> Ukryj kolumnę "Autobus LIVE", jeśli Pojazdy LIVE = NIE
                if (!doDodaniaNormalized["pojazdy live"]) {
                    const tabela = document.getElementById("PierwszaTabela");
                    if (tabela) {
                        // Ukryj nagłówek kolumny
                        const thList = tabela.querySelectorAll("thead th");
                        thList.forEach(th => {
                            if (th.textContent.trim().replace(/\s+/g, ' ') === "Autobus LIVE") {
                                th.style.display = "none";
                            }
                        });

                        // Ukryj istniejące komórki tej kolumny w każdym wierszu
                        const dataTableBody = document.getElementById("dataTableBody");
                        if (dataTableBody) {
                            const wiersze = dataTableBody.querySelectorAll("tr");
                            wiersze.forEach(tr => {
                                const komorki = tr.querySelectorAll("td");
                                if (komorki.length >= 6) {
                                    komorki[5].style.display = "none";
                                }
                            });

                            // Obserwator do ukrywania komórek w nowych wierszach
                            const observer = new MutationObserver(mutations => {
                                mutations.forEach(mutation => {
                                    mutation.addedNodes.forEach(node => {
                                        if (node.nodeType === 1 && node.tagName === "TR") {
                                            const komorki = node.querySelectorAll("td");
                                            if (komorki.length >= 6) {
                                                komorki[5].style.display = "none";
                                            }
                                        }
                                    });
                                });
                            });

                            observer.observe(dataTableBody, {
                                childList: true
                            });
                        }

                    }
                }

                const logoutBtn = document.getElementById('logout');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', function() {
                        const miasto = localStorage.getItem('Miasto');
                        localStorage.clear();
                        localStorage.setItem('Miasto', miasto);
                        window.location.href = 'index.html';
                    });
                }
            } catch (error) {
                console.error("Błąd podczas ładowania danych:", error);
            }
        });







        async function loadLinieFromFiles() {
            const miasto = localStorage.getItem('Miasto');
            const tableRows = document.querySelectorAll('#dataTableBody tr');

            for (const row of tableRows) {
                const brygadaCell = row.querySelector('td'); // pierwsza kolumna
                if (!brygadaCell) continue;

                const brygadaRaw = brygadaCell.textContent.trim();
                const brygadaPath = brygadaRaw.replace(/\//g, '_'); // zamień "/" na "_"

                const path = `../../../Brygady/${miasto}/WYNIKI/Gotowe_brygady/Niedzielny/${brygadaPath}/linie.txt`;

                try {
                    const response = await fetch(path);
                    if (!response.ok) throw new Error(`Brak pliku dla: ${brygadaRaw}`);

                    const text = await response.text();
                    const linie = text.trim().split('\n').map(l => l.trim());

                    console.log(`Brygada ${brygadaRaw} → Linie:`, linie);

                    // Przykład: wstaw linie do drugiej kolumny
                    const linieHTML = linie.map(linia =>
                        linia === "Rez" ?
                        `<span class="borderedRez" style="color: red;">${linia}</span>` :
                        `<span class="bordered" style="color: red;">${linia}</span>`
                    ).join(' ');


                    const linieCell = row.children[1];
                    if (linieCell) linieCell.innerHTML = `<center>${linieHTML}</center>`;

                } catch (error) {
                    console.warn(`Nie udało się wczytać linii dla ${brygadaRaw}:`, error);
                }
            }
        }

    </script>

    <p>
        <center>
            Rozkłady na dzień dzisiejszy nie uwzględniają czasu potrzebnego na przygotowanie i zakończenie pracy kierowcy. <br> Godziny rozpoczęcia i zakończenia pracy ustalane są na podstawie kursów liniowych przypisanych do danej brygady. <br><br>
        </center>
    </p>

</body>

</html>
