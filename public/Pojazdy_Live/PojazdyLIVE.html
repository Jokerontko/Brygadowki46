<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.6">
    <link rel="stylesheet" href="../../style_css/headermenu.css">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Szczegóły kursu</title>
    <style>
        body {
            background: rgb(50, 50, 50);
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            color: white;
        }

        h1 {
            font-size: 2rem;
            margin: 40px 0 10px;
        }

        table {
            width: 90%;
            max-width: 940px;
            border-collapse: collapse;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 20px;

        }

        th,
        td {
            text-align: center;
            padding: 10px;
            border: 1px solid #ccc;
            font-size: 17px;
        }

        thead {
            background-color: rgba(163, 120, 0);
        }

        .NrOflp {
            text-decoration: none;
            color: orange;
        }

        .hide {
            font-size: 0px;
            padding: 0px;
            border: 0px;
        }

        .Rez {
            padding: 0px;
            text-align: right;
            border-top: 1px solid;
            border-bottom: 1px solid;
            border-left: none;
            border-right: none;

        }

        .RezLP {
            padding: 0px;
            text-align: right;
            border-top: 1px solid;
            border-bottom: 1px solid;
            border-left: 1px solid;
            border-right: none;
        }

        p {
            color: grey;
        }

        #brygadaType {
            margin-top: -5px;
            color: grey;
        }

        #wykazbrygady {
            width: 30%;
        }

        header {
            position: sticky;
            top: 0px;
            background-color: rgb(50, 50, 50);
        }

        @keyframes blink {
            0% {
                background-color: red;
            }

            50% {
                background-color: transparent;
            }

            100% {
                background-color: red;
            }
        }

        .blink {
            animation: blink 1s infinite;
        }

        @keyframes blinkbrake {
            0% {
                background-color: transparent 20%;
            }

            50% {
                background-color: transparent;
            }

            100% {
                background-color: transparent 20%;
            }
        }

        .blinkbrake {
            animation: blinkbrake 2s infinite;
        }

        .BrakeDetected {
            color: white;
            pointer-events: visible;
        }

        .NoBrakeDetected {
            color: grey;
            pointer-events: none;
        }

        .PodmianaDetected {
            color: white;
            pointer-events: visible;
        }

        .NoPodmianaDetected {
            color: grey;
            pointer-events: none;
        }

        .highlightButton {
            color: white;
            pointer-events: visible;
        }

        .NohighlightButton {
            color: grey;
            pointer-events: none;
        }

        .PTDetected {
            color: white;
            pointer-events: visible;
        }

        .NoPTDetected {
            color: grey;
            pointer-events: none;
        }

        .buttons a {
            width: 170px;
            text-align: center;
        }

        .WNLZDZDetected {
            color: white;
            pointer-events: visible;
        }

        .NoWNLZDZDetected {
            color: grey;
            pointer-events: none;
        }

        .blocked {
            color: gray;
            cursor: not-allowed;
            display: inline-block;
            text-decoration: none;
            border: 1.5px solid;
            border-radius: 5px;
            padding: 10px 20px;
            margin: 5px 5px 5px;
        }

        select {
            background-color: rgb(50, 50, 50);
            color: white;
            border: 2px solid white;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 16px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;

            background-image: url("data:image/svg+xml;utf8,<svg fill='white' height='16' viewBox='0 0 24 24' width='16' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            padding-right: 30px;
        }

        .filter-input {
            display: inline-block;
            justify-content: center;
            align-items: center;
            text-align: center;
            text-decoration: none;
            color: white;
            background-color: rgba(50, 50, 50);
            border: 2px solid;
            border-radius: 10px;
            padding: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            width: 112px;
            max-width: 440px;
            margin-bottom: 10px;
        }

    </style>
</head>

<body>
    <header>
        <a href="../../Main_Panel.html" class="menu">Panel Główny</a>
        <a href="../../Przystanki/listaprzystankow.html" class="menu">Przystanki</a>
        <a href="../Brygady/ChooseDay.html" class="menu">Brygady</a>
        <a href="../../Brygady/Kursy/Kursy.html" class="menu">Kursy</a>
        <a href="#" class="menu">Pojazdy LIVE</a>
        <a href="#" class="menu exit" id="logout">Opuść Panel</a>
        <hr>
    </header>

    <h1>Pojazdy LIVE</h1>
    <p style="margin: 0px 0px 15px 0px;">Dostęp testowy</p>

    <div id="filtrowanie" style="width: 70%;">

    </div>
    <button id="dodajPojazd" style="display: none;">Dodaj pojazd</button>


    <table id="ulubione" style="display: none;">
        <thead>
            <tr>
                <th>Numer Autobusu</th>
                <th>Brygada</th>
                <th>Numer Linii</th>
                <th>Kierunek</th>
                <th>Godzina odjazdu</th>
            </tr>
        </thead>

        <tbody>

        </tbody>
    </table>

    <table id="wykazstrony" style="width: 90%;">
        <thead>
            <tr>
                <th>Numer Autobusu</th>
                <th>Brygada</th>
                <th style="display: none;">Model Autobusu</th>
                <th>Opóźnienie</th>
                <th>Numer Linii</th>
                <th>Kierunek</th>
                <th style="display: none;">Następny kierunek</th>
                <th>Godzina odjazdu</th>
            </tr>
        </thead>
        <tbody id="dane-wykaz">
            <!-- Wiersze zostaną dodane automatycznie -->
        </tbody>
    </table>






    <!--<button onclick="drukujRozklad()">Drukuj rozkład</button>-->


    <script>
        // Pobierz dane użytkownika z sessionStorage
        const user = JSON.parse(sessionStorage.getItem('user'));

        function checkLogin() {
            const user = JSON.parse(sessionStorage.getItem('user'));
            if (!user) {
                window.location.href = '../zoltakartka.html';
            }
        }

        window.onload = async function() {
            checkLogin();
        };


        document.getElementById('logout').addEventListener('click', function() {
            sessionStorage.clear();
            window.location.href = '../index.html';
        });



        let modelMap = [];
        let activeFilter = null;
        let activeDelaySort = '';
        let activeLineFilter = '';
        let activeBusNumberFilter = '';
        let wartoscdnia = ""; // domyślnie np. "Powszedni"
        let activeDzien = "2"; // Domyślnie Powszedni


        function parseModelFile(text) {
            modelMap = [];
            const lines = text.trim().split('\n');

            for (const line of lines) {
                const trimmed = line.trim();
                if (/^-{3,}.*-{3,}$/.test(trimmed)) {
                    modelMap.push({
                        model: trimmed,
                        entries: [],
                        display: '',
                        count: 0,
                        isCategory: true
                    });
                    continue;
                }

                const [rangePart, model] = trimmed.split('\t').map(s => s.trim());
                const entries = [];

                if (rangePart.includes(',')) {
                    entries.push(...rangePart.split(',').map(num => parseInt(num.trim(), 10)));
                } else if (rangePart.includes('-')) {
                    const [from, to] = rangePart.split('-').map(s => parseInt(s.trim(), 10));
                    for (let i = from; i <= to; i++) {
                        entries.push(i);
                    }
                } else if (!isNaN(rangePart)) {
                    entries.push(parseInt(rangePart, 10));
                }

                modelMap.push({
                    model,
                    entries,
                    display: rangePart,
                    count: 0,
                    isCategory: false
                });
            }
        }

        function updateModelCounts(vehicles) {
            modelMap.forEach(m => m.count = 0);
            for (const v of vehicles) {
                const nb = parseInt(v.getAttribute("nb"), 10);
                const matched = modelMap.find(entry => !entry.isCategory && entry.entries.includes(nb));
                if (matched) matched.count++;
            }
        }

        function renderFilters() {
            const filterDiv = document.getElementById("filtrowanie");
            filterDiv.innerHTML = '';

            const select = document.createElement('select');
            select.style.maxWidth = '100%';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- Wybierz model --';
            defaultOption.style.textAlign = 'center';
            defaultOption.style.backgroundColor = 'rgb(50,50,50)';
            defaultOption.selected = true;

            select.appendChild(defaultOption);

            modelMap.forEach(entry => {
                if (entry.isCategory) {
                    const categoryOption = document.createElement('option');
                    categoryOption.textContent = entry.model.replace(/^-+\s*|\s*-+$/g, '').trim();
                    categoryOption.disabled = true;
                    categoryOption.style.fontWeight = 'bold';
                    categoryOption.style.backgroundColor = '#333';
                    categoryOption.style.color = 'white';
                    categoryOption.style.textAlign = 'center';
                    select.appendChild(categoryOption);
                    return;
                }

                const option = document.createElement('option');
                option.value = entry.model;
                option.textContent = `${entry.display} • ${entry.model} • (${entry.count})`;

                if (entry.count === 0) {
                    option.disabled = true;
                }

                select.appendChild(option);
            });

            select.addEventListener('change', () => {
                activeFilter = select.value || null;
                applyFilters();
            });

            filterDiv.appendChild(select);

            const delaySelect = document.createElement('select');
            delaySelect.style.marginLeft = '10px';
            delaySelect.style.maxWidth = '100%';

            const delayDefault = document.createElement('option');
            delayDefault.value = '';
            delayDefault.textContent = '-- Sortuj po opóźnieniu --';
            delayDefault.selected = true;
            delaySelect.appendChild(delayDefault);

            const delayAsc = document.createElement('option');
            delayAsc.value = 'asc';
            delayAsc.textContent = 'Od największego do najmniejszego';
            delaySelect.appendChild(delayAsc);

            const delayDesc = document.createElement('option');
            delayDesc.value = 'desc';
            delayDesc.textContent = 'Od najmniejszego do największego';
            delaySelect.appendChild(delayDesc);

            delaySelect.value = activeDelaySort;

            delaySelect.addEventListener('change', () => {
                activeDelaySort = delaySelect.value;
                if (activeDelaySort === '') {
                    loadAndRenderTable();
                } else {
                    applyFilters();
                }
            });

            filterDiv.appendChild(delaySelect);

            const lineInput = document.createElement('input');
            lineInput.placeholder = 'Filtruj po linii...';
            lineInput.classList.add('filter-input');
            lineInput.style.marginLeft = '10px';
            lineInput.value = activeLineFilter;

            lineInput.addEventListener('input', () => {
                activeLineFilter = lineInput.value.trim();
                applyFilters();
            });

            filterDiv.appendChild(lineInput);

            const busInput = document.createElement('input');
            busInput.placeholder = 'Filtruj po numerze autobusu...';
            busInput.classList.add('filter-input');
            busInput.style.marginLeft = '10px';
            busInput.value = activeBusNumberFilter;

            busInput.addEventListener('input', () => {
                activeBusNumberFilter = busInput.value.trim();
                applyFilters();
            });

            filterDiv.appendChild(busInput);


            let dzienSelect = document.getElementById('dzienSelect');
            if (!dzienSelect) {
                dzienSelect = document.createElement('select');
                dzienSelect.id = 'dzienSelect';
                dzienSelect.style.marginLeft = '10px';
                dzienSelect.style.maxWidth = '100%';

                const dzienOptions = [{
                        label: 'Powszedni',
                        value: '2'
                    },
                    {
                        label: 'Powszedni Wolny',
                        value: '3'
                    },
                    {
                        label: 'Sobotni',
                        value: '4'
                    },
                    {
                        label: 'Niedzielny',
                        value: '1'
                    }
                ];

                dzienOptions.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.label;
                    dzienSelect.appendChild(option);
                });

                dzienSelect.value = sessionStorage.getItem('activeDzien') || activeDzien;

                dzienSelect.addEventListener('change', () => {
                    activeDzien = dzienSelect.value;
                    sessionStorage.setItem('activeDzien', activeDzien);
                    loadAndRenderTable(); // przeładuj dane przy zmianie
                });

                filterDiv.appendChild(dzienSelect);
            }

            // Aktualizuj globalną zmienną zgodnie z tym, co jest w select:
            activeDzien = dzienSelect.value;


            filterDiv.appendChild(dzienSelect);



            if (activeFilter) {
                select.value = activeFilter;
            }
        }

        function applyFilters() {
            const rows = Array.from(document.querySelectorAll('#dane-wykaz tr'));

            rows.forEach(row => {
                const modelCell = row.cells[1];
                const lineCell = row.cells[4];
                const busNumberCell = row.cells[0];

                const matchesModel = !activeFilter || modelCell.textContent.trim() === activeFilter;
                const matchesLine = !activeLineFilter || lineCell.textContent.trim() === activeLineFilter;
                const matchesBusNumber = !activeBusNumberFilter || busNumberCell.textContent.trim() === activeBusNumberFilter;

                row.style.display = (matchesModel && matchesLine && matchesBusNumber) ? '' : 'none';
            });

            if (activeDelaySort) {
                const sortedRows = rows
                    .filter(row => row.style.display !== 'none')
                    .sort((a, b) => {
                        const delayA = a.cells[3].textContent.trim();
                        const delayB = b.cells[3].textContent.trim();

                        const valueA = parseDelay(delayA);
                        const valueB = parseDelay(delayB);

                        return activeDelaySort === 'asc' ? valueA - valueB : valueB - valueA;
                    });

                const tbody = document.getElementById('dane-wykaz');
                sortedRows.forEach(row => tbody.appendChild(row));
            }
        }

        function parseDelay(text) {
            const match = text.match(/([-+])(\d{2}):(\d{2})/);
            if (!match) return 0;
            const sign = match[1] === '+' ? 1 : -1;
            const minutes = parseInt(match[2], 10);
            const seconds = parseInt(match[3], 10);
            return sign * (minutes * 60 + seconds);
        }

        function LoadBrygada(godzinaOdjazdu, kierunek, dzien, linia, callback) {
            fetch(`/api/brygada?godzina=${encodeURIComponent(godzinaOdjazdu)}&kierunek=${encodeURIComponent(kierunek)}&dzien=${encodeURIComponent(dzien)}&nr=${encodeURIComponent(linia)}`)



                .then(response => response.json())
                .then(data => {
                    console.log('Dane otrzymane od serwera:', data);
                    // Przekazanie obu wartości do callbacka
                    callback(data.brygada, data.linia); // Przekazanie również linia
                })
                .catch(error => {
                    console.error('Błąd przy pobieraniu danych:', error);
                    callback('Błąd');
                });
        }



        function loadAndRenderTable(dzien) {
            dzien = dzien || (document.getElementById('dzienSelect')?.value || activeDzien);


            const scrollTop = window.scrollY;
            const activeElement = document.activeElement;
            const wasFocused = activeElement?.tagName === 'SELECT' || activeElement?.tagName === 'INPUT';

            fetch('/api/vehicles')
                .then(response => response.text())
                .then(xmlString => {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlString, "text/xml");
                    const vehicles = Array.from(xmlDoc.getElementsByTagName("V"));

                    vehicles.sort((a, b) => {
                        const nbA = parseInt(a.getAttribute("nb")) || 0;
                        const nbB = parseInt(b.getAttribute("nb")) || 0;
                        return nbA - nbB;
                    });

                    updateModelCounts(vehicles);
                    renderFilters();

                    const tbody = document.getElementById("dane-wykaz");
                    tbody.innerHTML = "";

                    vehicles.forEach(v => {
                        const nb = v.getAttribute("nb");
                        let nr = v.getAttribute("nr") || '';
                        const nnr = v.getAttribute("nnr") || '';

                        let op = v.getAttribute("op") || '';
                        const nop = v.getAttribute("nop") || '';
                        let p = v.getAttribute("p") || '';
                        const o = parseInt(v.getAttribute("o"), 10);
                        const isDelayed = o < 0;
                        const absO = Math.abs(o);

                        const minutes = Math.floor(absO / 60);
                        const seconds = absO % 60;
                        const formattedDelay = `${isDelayed ? '-' : '+'}${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                        const totalSeconds = (isDelayed ? -1 : 1) * (minutes * 60 + seconds);

                        let color = "#ffffff";
                        if (totalSeconds >= 1) {
                            color = "#0e8616";
                        } else if (totalSeconds < 0 && totalSeconds >= -300) {
                            color = "#ffbb00";
                        } else if (totalSeconds < -300 && totalSeconds >= -600) {
                            color = "#ff8000";
                        } else if (totalSeconds < -600 && totalSeconds >= -1200) {
                            color = "#ff0000";
                        } else if (totalSeconds < -1200) {
                            color = "#a80000";
                        }

                        const formattedTimeReal = `<span style="color: ${color}">${formattedDelay}</span>`;

                        if ((!nr || nr.trim() === '') && (!op || op.trim() === '') && (!p || p.trim() === '')) {
                            if (nop && nop.trim() !== '') {
                                op = `<span style="color: gray">${nop}</span>`;
                            }
                            if (nnr && nnr.trim() !== '') {
                                nr = `<span style="color: gray">${nnr}</span>`;
                            }




                            const now = new Date();
                            now.setSeconds(now.getSeconds() + totalSeconds);

                            if (now.getSeconds() >= 0 && now.getSeconds() < 30) {
                                now.setSeconds(0);
                            } else if (now.getSeconds() >= 30 && now.getSeconds() < 60) {
                                now.setMinutes(now.getMinutes() + 1);
                                now.setSeconds(0);
                            }

                            const hours = now.getHours().toString().padStart(2, '0');
                            const mins = now.getMinutes().toString().padStart(2, '0');
                            p = `${hours}:${mins}`;
                        }

                        const nbNum = parseInt(nb, 10);
                        const matched = modelMap.find(entry => !entry.isCategory && entry.entries.includes(nbNum));
                        const model = matched ? matched.model : 'N/A';

                        // Jeśli kierunek zawiera "p.", to umieszczamy resztę w <span>
                        let formattedOp = op;
                        const pIndex = op.toLowerCase().indexOf("p.");
                        if (pIndex !== -1) {
                            const before = op.slice(0, pIndex).trim();
                            const after = op.slice(pIndex).trim();
                            formattedOp = `${before} <br> <span>${after}</span>`;
                        }

                        const row = document.createElement("tr");
                        row.innerHTML = `
    <td>${nb}</td>
    <td style="display: none;">${model}</td>
    <td>${formattedTimeReal}</td>
    <td>${nr}</td>
    <td>${formattedOp}</td>
    <td style="display: none;">${nop}</td>
    <td>${p}</td>
`;

                        tbody.appendChild(row);

                        const godzinaOdjazdu = row.cells[6].textContent.trim();
                        const kierunek = row.cells[4].textContent.trim();
                        const linia = row.cells[3].textContent.trim(); // nr

                        const cellBrygada = row.insertCell(2);
                        const cellLinie = row.cells[4];

                        // Funkcja LoadBrygada, która zwraca brygadę i linię
                        LoadBrygada(godzinaOdjazdu, kierunek, activeDzien, linia, function(brygada, linia) {


                            // Sprawdzamy, czy brygada zawiera "Folder:" i usuwamy go
                            if (brygada.includes("Folder:")) {
                                brygada = brygada.replace("Folder:", "").trim(); // Usuwamy "Folder:" i przycinamy nadmiarowe spacje
                            }

                            // Zamiana "_" na "/"
                            brygada = brygada.replace(/_/g, "/");

                            // Ustawienie brygady w komórce
                            if (cellBrygada.textContent.trim() !== brygada) {
                                cellBrygada.textContent = brygada;
                            }


                            // Sprawdzamy, czy komórka "linie" zawiera jakąkolwiek wartość (nie jest pusta)
                            if (cellLinie.textContent.trim() === "") {
                                // Nadpisanie wartości linii, jeśli komórka nie jest pusta
                                cellLinie.textContent = linia;
                                // Zmiana koloru na różowy
                                cellLinie.style.color = 'grey';

                                // Zmiana koloru również w kolumnie Kierunek
                                const cellKierunek = row.cells[5];
                                cellKierunek.style.color = 'grey';

                                const cellOpoznienie = row.cells[3];
                                cellOpoznienie.style.color = 'white';
                            }

                        });









                    });

                    applyFilters();

                    if (wasFocused) {
                        activeElement?.focus();
                    }

                    window.scrollTo({
                        top: scrollTop
                    });
                })
                .catch(error => {
                    console.error('Błąd przy pobieraniu danych:', error);
                });
        }

        fetch('ModeleAutobusow.txt')
            .then(response => response.text())
            .then(text => {
                checkLogin();
                parseModelFile(text);
                loadAndRenderTable();
                setInterval(() => {
                    loadAndRenderTable();
                    aktualizujUlubione();
                }, 20000);
            })
            .catch(err => console.error('Błąd ładowania pliku modeli:', err));

        function sprawdzDostepnosc() {
            console.log("Sprawdzanie dostępności...");
        }









        document.getElementById("wykazstrony").addEventListener("click", async function(e) {
            const cell = e.target;
            if (cell.tagName === "TD" && cell.cellIndex === 2) {
                const row = cell.parentElement;
                const brygada = row.cells[2].textContent.trim(); // kolumna "Brygada"
                const modifiedBrygada = brygada.replace(/\//g, '_');
                sessionStorage.setItem('brygadaTitle', modifiedBrygada);

                // Pobierz activeDzien z sessionStorage
                const activeDzien = sessionStorage.getItem('activeDzien') || '2';

                // Określ JakiTYPdnia
                let JakiTYPdnia = "Powszedni";
                let rodzajDniaForFile = 2;
                switch (activeDzien) {
                    case "1":
                        JakiTYPdnia = "Niedzielny";
                        rodzajDniaForFile = 1;
                        break;
                    case "3":
                        JakiTYPdnia = "PowszedniWolny";
                        rodzajDniaForFile = 3;
                        break;
                    case "4":
                        JakiTYPdnia = "Sobotni";
                        rodzajDniaForFile = 4;
                        break;
                }

                const filePath = `../../../Brygady/WYNIKI/Gotowe_brygady/${rodzajDniaForFile}/Brygady_BIS.txt`;
                sessionStorage.setItem('ChoosedTypeOfDay', rodzajDniaForFile);


                try {
                    const response = await fetch(filePath);
                    const data = await response.text();
                    const lines = data.split('\n').slice(2); // pomiń 2 pierwsze linie

                    function findBrygadaType(searchBrygada) {
                        for (const line of lines) {
                            const [currentBrygada, typBrygady] = line.split('\t');
                            if (currentBrygada?.trim() === searchBrygada) {
                                switch (typBrygady?.trim()) {
                                    case 'JZ':
                                        return 'Brygada Jednozmianowa';
                                    case 'X':
                                        return 'Brygada Dwuzmianowa';
                                    case 'B':
                                        return 'Brygada Szczytowa';
                                    case 'JZN':
                                        return 'Brygada Nocna Jednozmianowa';
                                    case 'DZN':
                                        return 'Brygada Nocna Dwuzmianowa';
                                }
                            }
                        }
                        return null;
                    }

                    let brygadaType = findBrygadaType(modifiedBrygada);

                    if (!brygadaType) {
                        const originalBrygada = modifiedBrygada.replace(/_/g, '/');
                        brygadaType = findBrygadaType(originalBrygada);
                    }

                    if (brygadaType) {
                        sessionStorage.setItem('BrygadaType', brygadaType);
                    } else {
                        console.error('Nie znaleziono typu brygady dla:', modifiedBrygada);
                    }

                } catch (error) {
                    console.error('Błąd podczas pobierania lub przetwarzania pliku:', error);
                }

                // Przekierowanie
                window.location.href = `../Brygady/${JakiTYPdnia}/brygada.html`;
            }
        });









        async function dodajPojazdDoTabeli(numer) {
            const response = await fetch("ModeleAutobusow.txt");
            const text = await response.text();

            const lines = text.trim().split('\n');

            for (const line of lines) {
                const trimmed = line.trim();
                if (/^-{3,}.*-{3,}$/.test(trimmed)) continue;

                const [rangePart] = trimmed.split('\t').map(s => s.trim());
                let entries = [];

                if (rangePart.includes(',')) {
                    entries = rangePart.split(',').map(n => parseInt(n.trim(), 10));
                } else if (rangePart.includes('-')) {
                    const [from, to] = rangePart.split('-').map(n => parseInt(n.trim(), 10));
                    for (let i = from; i <= to; i++) entries.push(i);
                } else if (!isNaN(rangePart)) {
                    entries = [parseInt(rangePart, 10)];
                }

                if (entries.includes(numer)) {
                    const table = document.getElementById("ulubione").querySelector("tbody");
                    const row = table.insertRow();

                    const cellNumer = row.insertCell();
                    cellNumer.textContent = numer;

                    const btnUsun = document.createElement("button");
                    btnUsun.textContent = "X";
                    btnUsun.style.color = "red";
                    btnUsun.style.position = "absolute";
                    btnUsun.style.top = "0";
                    btnUsun.style.right = "0";
                    btnUsun.style.border = "none";
                    btnUsun.style.backgroundColor = "transparent";
                    btnUsun.style.cursor = "pointer";
                    btnUsun.addEventListener("click", () => {
                        row.remove();
                        usunZLocalStorage(numer);
                    });

                    cellNumer.style.position = "relative";
                    cellNumer.appendChild(btnUsun);

                    row.insertCell().textContent = "";
                    row.insertCell().textContent = "";
                    row.insertCell().textContent = "";
                    row.insertCell().textContent = "";

                    return;
                }
            }
            console.log("Nie znaleziono pojazdu.");
        }

        function usunZLocalStorage(numer) {
            let ulubionePojazdy = JSON.parse(localStorage.getItem("ulubionePojazdy")) || [];
            ulubionePojazdy = ulubionePojazdy.filter(n => n !== numer);
            localStorage.setItem("ulubionePojazdy", JSON.stringify(ulubionePojazdy));
        }

        function aktualizujUlubione() {
            // Miejsce na dodatkowe działania po aktualizacji listy (np. sortowanie)
        }

        document.getElementById("dodajPojazd").addEventListener("click", async function() {
            const input = prompt("Podaj numer pojazdu:");
            if (!input) return;

            const numer = parseInt(input.trim(), 10);
            if (isNaN(numer)) {
                console.log("Nieprawidłowy numer.");
                return;
            }

            const sukces = await dodajPojazdDoTabeli(numer);
            if (!sukces) {
                console.log("Nie znaleziono pojazdu.");
                return;
            }

            let ulubionePojazdy = JSON.parse(localStorage.getItem("ulubionePojazdy")) || [];
            if (!ulubionePojazdy.includes(numer)) {
                ulubionePojazdy.push(numer);
                localStorage.setItem("ulubionePojazdy", JSON.stringify(ulubionePojazdy));
            }

            aktualizujUlubione();
        });


        window.addEventListener("DOMContentLoaded", async () => {
            const ulubionePojazdy = JSON.parse(localStorage.getItem("ulubionePojazdy")) || [];
            for (const numer of ulubionePojazdy) {
                await dodajPojazdDoTabeli(numer);
            }
        });

        // Załaduj ulubione pojazdy z localStorage przy wczytywaniu strony
        window.addEventListener("DOMContentLoaded", () => {
            const ulubionePojazdy = JSON.parse(localStorage.getItem("ulubionePojazdy")) || [];
            ulubionePojazdy.forEach(numer => {
                const table = document.getElementById("ulubione").querySelector("tbody");
                const row = table.insertRow();

                const cellNumer = row.insertCell();
                cellNumer.textContent = numer;

                // Dodanie przycisku "X" do usuwania wiersza
                const btnUsun = document.createElement("button");
                btnUsun.textContent = "X";
                btnUsun.style.color = "red";
                btnUsun.style.position = "absolute";
                btnUsun.style.top = "0";
                btnUsun.style.right = "0";
                btnUsun.style.border = "none";
                btnUsun.style.backgroundColor = "transparent";
                btnUsun.style.cursor = "pointer";
                btnUsun.addEventListener("click", () => {
                    row.remove(); // Usuwanie wiersza z tabeli
                    usunZLocalStorage(numer); // Usuwanie z localStorage
                });

                // Umieszczamy przycisk w komórce "Numer"
                cellNumer.style.position = "relative";
                cellNumer.appendChild(btnUsun);

                const cellModel = row.insertCell();
                cellModel.textContent = ""; // Można wpisać np. "Nieznany"

                const cellDodano = row.insertCell();
                cellDodano.textContent = ""; // Można dodać czas, kiedy pojazd został dodany

                // Uzupełnienie danych o brygadzie, numerze linii, kierunku i godzinie odjazdu
                uzupełnijDaneZTabelaWykazstrony(numer, row);
            });
        });

        // Funkcja usuwająca pojazd z localStorage
        function usunZLocalStorage(numer) {
            let ulubionePojazdy = JSON.parse(localStorage.getItem("ulubionePojazdy")) || [];
            ulubionePojazdy = ulubionePojazdy.filter(n => n !== numer);
            localStorage.setItem("ulubionePojazdy", JSON.stringify(ulubionePojazdy));
        }

        // Funkcja uzupełniająca dane z tabeli o id="wykazstrony"
        function aktualizujUlubione() {
            const tabelaUlubione = document.querySelector('#ulubione tbody');
            const tabelaWykaz = document.querySelectorAll('#wykazstrony tbody tr');

            const wierszeUlubione = tabelaUlubione.querySelectorAll('tr');

            for (const wierszUlubiony of wierszeUlubione) {
                const numerUlubiony = wierszUlubiony?.cells[0]?.textContent.trim().normalize().replace(/X$/, '');

                if (!numerUlubiony) {
                    console.log("Brak numeru autobusu w wierszu:", wierszUlubiony);
                    continue;
                }

                console.log("Szukany numer:", JSON.stringify(numerUlubiony));

                for (const wierszWykazu of tabelaWykaz) {
                    const numerZwykazu = wierszWykazu.cells[0].textContent.trim().normalize();
                    console.log("Sprawdzam z:", JSON.stringify(numerZwykazu));

                    if (numerUlubiony === numerZwykazu) {
                        console.log("ZNALAZŁEM");

                        const brygada = wierszWykazu.cells[2].textContent.trim();
                        const numerLinii = wierszWykazu.cells[4].textContent.trim();
                        const kierunek = wierszWykazu.cells[5].textContent.trim();
                        const godzinaOdjazdu = wierszWykazu.cells[7].textContent.trim();

                        // Upewnij się, że wiersz ma 5 komórek
                        while (wierszUlubiony.cells.length < 5) {
                            wierszUlubiony.insertCell();
                        }

                        // Uzupełniamy dane
                        wierszUlubiony.cells[1].textContent = brygada;
                        wierszUlubiony.cells[2].textContent = numerLinii;
                        wierszUlubiony.cells[3].textContent = kierunek;
                        wierszUlubiony.cells[4].textContent = godzinaOdjazdu;

                        console.log("Dane zostały zaktualizowane w tabeli ulubione.");
                        break;
                    }
                }
            }
        }

    </script>










</body>

</html>
